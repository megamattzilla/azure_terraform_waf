# Overview
The following Ansible playbooks will configure the deployed BIG-IPs with base ASM policy and configure the desired virtual servers via AS3.

# Requirements
You'll need to ensure you have Ansible 2.8 or 2.9 installed. The following instructions are for Ubuntu:
```bash
apt-add-repository ppa:ansible/ansible
sudo apt update
apt install ansible
```
Note: this may install ansible using python 2.7. Ansible using python 3.6.x is required for these playbooks. 
These playbooks have been tested with ansible 2.9.x using python 3.6.x 

You'll need to have Python PIP and the following python modules and ansible roles installed:
```bash
sudo apt-get install python-pip
sudo pip install msrest
sudo pip install msrestazure
sudo pip install azure-cli
sudo pip install azure-core
ansible-galaxy install f5devcentral.atc_deploy
```
 
# Running Ansible
Ensure that your ansible inventory is working correctly
```bash
export RESOURCE_GROUP_NAME=demo-rg-12ab
# or
export RESOURCE_GROUP_NAME=`az group list --output tsv  --query "[?starts_with(name, 'demo')]".name`
sed -i 's/_resource_group_/'"$RESOURCE_GROUP_NAME"'/g' azure_rm.yml
git update-index --assume-unchanged azure_rm.yml
ansible-inventory --graph
```

Export the required variables generated by Terraform before running your playbook
```bash
az login
export KEYVAULT_NAME=`az keyvault list --resource-group $RESOURCE_GROUP_NAME --output tsv --query "[0].name"`
export BIGIP_PASSWORD=`az keyvault secret show --name bigip-password --vault-name $KEYVAULT_NAME --query value --output tsv`
```
You can now run all playbooks by running site.yml below, or by running the specific playbook directly.

Run all playbooks
```
ansible-playbook ./site.yml
```

site.yml contains the following playbooks 

```
# file: site.yml
- import_playbook: import_custom_asm_signatures.yml
- import_playbook: import_attack_signature_version.yml
- import_playbook: import_waf_policies.yml
- import_playbook: import_ltm_config.yml
- import_playbook: create_declaration.yml
- import_playbook: as3.yml
```

# Playbook Overview
Common variables for all playbooks
```bash
  hosts: tag_Ansible_ltm:!tag_environment_gold # hosts is using Azure tags to select targets for the playbook. This tag combination select all ltm BIG-IPs except those in the gold environment
  connection: local
  vars:
    base_git_repo_path: "{{ playbook_dir }}/files/policy" #Specify local directory to store the contents of the configuration git repo 
    git_url: "git@example.local" #Specify URL of the configuration git repo
    git_key: "{{ lookup('file','~/.ssh/id_rsa') }}" #Specify SSH key to use to authenticate to configuration git repo
    git_repo_path: "{{ playbook_dir }}/files/policy" #Sets git repo path
    git_msg: "asm policy update" #Specify commit description text if playbook pushes changes to repo (only gold-policy playbooks)
    git_local_only: true #Set to true to skip fetching updated files from remote repo and instead use local files only. 
    staging_tag: "tag_purpose_test" #Specify Azure tag to indicate the Big-IP is used for testing. Playbook will use staging branch configuration for nodes with this tag. 
    provider:
      server: "{{ ansible_host }}"
      user: admin
      password: "{{ lookup('env','BIGIP_PASSWORD') }}" #Use BASH variable $BIGIP_PASSWORD to populate the password variable. 
      validate_certs: false
      server_port: 443 #Set the Big-IP HTTPS service port 
  gather_facts: false
  any_errors_fatal: true
```

### Playbook import_custom_asm_signatures.yml
- Pulls the latest configuration from the configuration management repo.
- Stores the master branch and staging branch from the repo into two local directories
- Imports custom attack signatures from the master branch directory to all Big-IP targets unless they contain the staging tag. If staging tag is present the staging directory is used to look for the custom attack signatures.
- Is expecting .xml file in directory {{ playbook_dir }}/files/policy/<branch>/ASM_custom_signatures/*.xml which contains the exported custom attack signatures from ASM.
- If multiple .xml files are located, they will each be imported to the target Big-IPs.
- The task waits for successful custom attack signature install condition before finishing the task.
- The playbook task waits 180 seconds for the install task to complete. If more time is needed, this can be adjusted. 
 
### Playbook import_attack_signature_version.yml
- Pulls the latest configuration from the configuration management repo.
- Stores the master branch and staging branch from the repo into two local directories
- Imports the attack signature package version from the master branch directory to all Big-IP targets unless they contain the staging tag. If staging tag is present the staging directory is used to look for the attack signature package version.
- Is expecting .im file in directory {{ playbook_dir }}/files/policy/<branch>/ASM_signature_version/*.im which contains the attack signatures file from downloads.f5.com.
- Only a single .im file should be located in the directory. If multiple .im files are found, they will all be installed in series, which will cause undesired behavior. 
- The task waits for successful attack signature version install condition before finishing the task.
- The playbook task waits 180 seconds for the install task to complete. If more time is needed, this can be adjusted. 

### Playbook import_waf_policies.yml
- Pulls the latest configuration from the configuration management repo.
- Stores the master branch and staging branch from the repo into two local directories
- Imports the ASM policies from the master branch directory to all Big-IP targets unless they contain the staging tag. If staging tag is present the staging directory is used to look for the ASM policies.
- Is expecting .xml files in directory {{ playbook_dir }}/files/policy/<branch>/*.xml which contains all the exported ASM policies.
- If multiple .xml files are found, they will all be imported.
- The task waits for successful ASM policy install condition before finishing the task.
- The playbook tasks also applies all imported ASM policies
  
### Playbook import_ltm_config.yml
- This task imports LTM configuration that either AS3 does not support, or is LTM configuration preferred to load outside of AS3 (iRules, Datagroups, Bot profiles, DoS profiles). 
- Any configuration element an iRule references should be imported with this playbook. 
- Pulls the latest configuration from the configuration management repo.
- Stores the master branch and staging branch from the repo into two local directories
- Imports the LTM TMSH configuration from the master branch directory to all Big-IP targets unless they contain the staging tag. If staging tag is present the staging directory is used to look for the LTM TMSH configuration.
- Is expecting tmsh.config files in directory {{ playbook_dir }}/files/policy/<branch>/LTM_configuration/tmsh.config which contains all the exported LTM configuration.
- The task waits for successful LTM TMSH configuration install condition before finishing the task.
- The playbook tasks also saves TMSH configuration

 ### Playbook create_declaration.yml
 - This task renders the AS3 JSON declaration using the F5 configuration in .yml format from {{ playbook_dir }}/files/policy/<branch>/LTM_configuration/*yml. 
 - Jinja2 template file {{ playbook_dir }}/as3-webapp-declaration.j2 is used to create the declaration. 
 - The F5 .yml configuration files in master and staging branch will be rendered into a master and staging declaration in their respective directories. 

 ### Playbook as3.yml
- This task imports LTM configuration via the Big-IP AS3 API endpoint.  
- Pulls the latest configuration from the configuration management repo.
- Is expecting as3.json file in directory {{ playbook_dir }}/files/policy/<branch>/LTM_configuration/*.json which contains the configuration in JSON format.
- The task waits for successful LTM AS3 configuration install condition before finishing the task.

